name: GitOps CI (build + push + bump Helm)

on:
 push:
  branches: ["gitops"]
  paths:
   - "app/**"
   - ".github/workflows/gitops-ci.yml"
   - "helm/**"

permissions:
 id-token: write
 contents: write

env:
 AWS_REGION: us-east-1
 ECR_REPO: hello-python
 HELM_VALUES: helm/hello-python/values.yaml

jobs:
 build_push_and_bump:
  runs-on: ubuntu-latest

  steps:
   - name: Checkout
     uses: actions/checkout@v4

   - name: Set image tag (short SHA)
     id: vars
     run: echo "TAG=${GITHUB_SHA::7}" >> $GITHUB_OUTPUT

   - name: Configure AWS creds (OIDC)
     uses: aws-actions/configure-aws-credentials@v4
     with:
      role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
      aws-region: ${{ env.AWS_REGION }}

   - name: Login to ECR
     uses: aws-actions/amazon-ecr-login@v2

   - name: Build + Push image
     run: |
      ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
      IMAGE_URI="${ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${ECR_REPO}:${{ steps.vars.outputs.TAG }}"
      echo "IMAGE_URI=$IMAGE_URI" >> $GITHUB_ENV

      docker build -t "$IMAGE_URI" ./app/hello-python
      docker push "$IMAGE_URI"

   - name: Update Helm values.yaml image tag
     run: |
      sed -i "s/^\(\s*tag:\s*\).*/\1\"${{ steps.vars.outputs.TAG }}\"/" "${HELM_VALUES}"
      echo "Updated ${HELM_VALUES} to tag=${{ steps.vars.outputs.TAG }}"
      cat "${HELM_VALUES}" | sed -n '1,120p'

   - name: Commit + push Helm bump
     run: |
      git config user.name "github-actions[bot]"
      git config user.email "github-actions[bot]@users.noreply.github.com"
      git add "${HELM_VALUES}"
      git commit -m "ci: bump image tag to ${{ steps.vars.outputs.TAG }}" || echo "No changes to commit"
      git push
